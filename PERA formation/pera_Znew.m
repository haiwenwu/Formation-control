function Znew = pera_Znew(q,e)
% 7dof

%% STATES
q_1=q(1); q_2=q(2); q_3=q(3); q_4=q(4); q_5=q(5); q_6=q(6); q_7=q(7);
e_1=e(1); e_2=e(2); e_3=e(3);


%%
J11 = [ sin(q_1)*sin(q_2), -1.0*cos(q_1)*cos(q_2), 0, 0, 0, 0, 0];
J12 = [ cos(q_4)*sin(q_1)*sin(q_2) + cos(q_1)*sin(q_3)*sin(q_4) + cos(q_2)*cos(q_3)*sin(q_1)*sin(q_4), cos(q_1)*cos(q_3)*sin(q_2)*sin(q_4) - 1.0*cos(q_1)*cos(q_2)*cos(q_4), cos(q_3)*sin(q_1)*sin(q_4) + cos(q_1)*cos(q_2)*sin(q_3)*sin(q_4), cos(q_1)*sin(q_2)*sin(q_4) + cos(q_4)*sin(q_1)*sin(q_3) - 1.0*cos(q_1)*cos(q_2)*cos(q_3)*cos(q_4), 0, 0, 0];
J13 = [ cos(q_2)*cos(q_5)*sin(q_1)*sin(q_3)*sin(q_7) - 1.0*cos(q_1)*cos(q_3)*cos(q_6)*cos(q_7)*sin(q_5) - 1.0*cos(q_1)*cos(q_3)*cos(q_5)*sin(q_7) + cos(q_1)*cos(q_4)*sin(q_3)*sin(q_5)*sin(q_7) - 1.0*cos(q_4)*cos(q_7)*sin(q_1)*sin(q_2)*sin(q_6) - 1.0*cos(q_1)*cos(q_7)*sin(q_3)*sin(q_4)*sin(q_6) - 1.0*sin(q_1)*sin(q_2)*sin(q_4)*sin(q_5)*sin(q_7) - 1.0*cos(q_1)*cos(q_4)*cos(q_5)*cos(q_6)*cos(q_7)*sin(q_3) + cos(q_2)*cos(q_3)*cos(q_4)*sin(q_1)*sin(q_5)*sin(q_7) - 1.0*cos(q_2)*cos(q_3)*cos(q_7)*sin(q_1)*sin(q_4)*sin(q_6) + cos(q_2)*cos(q_6)*cos(q_7)*sin(q_1)*sin(q_3)*sin(q_5) + cos(q_5)*cos(q_6)*cos(q_7)*sin(q_1)*sin(q_2)*sin(q_4) - 1.0*cos(q_2)*cos(q_3)*cos(q_4)*cos(q_5)*cos(q_6)*cos(q_7)*sin(q_1), cos(q_1)*cos(q_2)*cos(q_4)*cos(q_7)*sin(q_6) + cos(q_1)*cos(q_5)*sin(q_2)*sin(q_3)*sin(q_7) + cos(q_1)*cos(q_2)*sin(q_4)*sin(q_5)*sin(q_7) - 1.0*cos(q_1)*cos(q_2)*cos(q_5)*cos(q_6)*cos(q_7)*sin(q_4) + cos(q_1)*cos(q_3)*cos(q_4)*sin(q_2)*sin(q_5)*sin(q_7) - 1.0*cos(q_1)*cos(q_3)*cos(q_7)*sin(q_2)*sin(q_4)*sin(q_6) + cos(q_1)*cos(q_6)*cos(q_7)*sin(q_2)*sin(q_3)*sin(q_5) - 1.0*cos(q_1)*cos(q_3)*cos(q_4)*cos(q_5)*cos(q_6)*cos(q_7)*sin(q_2), cos(q_5)*sin(q_1)*sin(q_3)*sin(q_7) - 1.0*cos(q_1)*cos(q_2)*cos(q_3)*cos(q_5)*sin(q_7) + cos(q_3)*cos(q_4)*sin(q_1)*sin(q_5)*sin(q_7) - 1.0*cos(q_3)*cos(q_7)*sin(q_1)*sin(q_4)*sin(q_6) + cos(q_6)*cos(q_7)*sin(q_1)*sin(q_3)*sin(q_5) - 1.0*cos(q_1)*cos(q_2)*cos(q_3)*cos(q_6)*cos(q_7)*sin(q_5) - 1.0*cos(q_3)*cos(q_4)*cos(q_5)*cos(q_6)*cos(q_7)*sin(q_1) + cos(q_1)*cos(q_2)*cos(q_4)*sin(q_3)*sin(q_5)*sin(q_7) - 1.0*cos(q_1)*cos(q_2)*cos(q_7)*sin(q_3)*sin(q_4)*sin(q_6) - 1.0*cos(q_1)*cos(q_2)*cos(q_4)*cos(q_5)*cos(q_6)*cos(q_7)*sin(q_3), cos(q_1)*cos(q_4)*sin(q_2)*sin(q_5)*sin(q_7) - 1.0*cos(q_1)*cos(q_7)*sin(q_2)*sin(q_4)*sin(q_6) - 1.0*cos(q_4)*cos(q_7)*sin(q_1)*sin(q_3)*sin(q_6) - 1.0*sin(q_1)*sin(q_3)*sin(q_4)*sin(q_5)*sin(q_7) + cos(q_1)*cos(q_2)*cos(q_3)*cos(q_4)*cos(q_7)*sin(q_6) - 1.0*cos(q_1)*cos(q_4)*cos(q_5)*cos(q_6)*cos(q_7)*sin(q_2) + cos(q_1)*cos(q_2)*cos(q_3)*sin(q_4)*sin(q_5)*sin(q_7) + cos(q_5)*cos(q_6)*cos(q_7)*sin(q_1)*sin(q_3)*sin(q_4) - 1.0*cos(q_1)*cos(q_2)*cos(q_3)*cos(q_5)*cos(q_6)*cos(q_7)*sin(q_4), cos(q_3)*sin(q_1)*sin(q_5)*sin(q_7) - 1.0*cos(q_3)*cos(q_5)*cos(q_6)*cos(q_7)*sin(q_1) + cos(q_1)*cos(q_2)*sin(q_3)*sin(q_5)*sin(q_7) + cos(q_1)*cos(q_5)*sin(q_2)*sin(q_4)*sin(q_7) + cos(q_4)*cos(q_5)*sin(q_1)*sin(q_3)*sin(q_7) - 1.0*cos(q_1)*cos(q_2)*cos(q_3)*cos(q_4)*cos(q_5)*sin(q_7) - 1.0*cos(q_1)*cos(q_2)*cos(q_5)*cos(q_6)*cos(q_7)*sin(q_3) + cos(q_1)*cos(q_6)*cos(q_7)*sin(q_2)*sin(q_4)*sin(q_5) + cos(q_4)*cos(q_6)*cos(q_7)*sin(q_1)*sin(q_3)*sin(q_5) - 1.0*cos(q_1)*cos(q_2)*cos(q_3)*cos(q_4)*cos(q_6)*cos(q_7)*sin(q_5), cos(q_1)*cos(q_4)*cos(q_6)*cos(q_7)*sin(q_2) - 1.0*cos(q_6)*cos(q_7)*sin(q_1)*sin(q_3)*sin(q_4) + cos(q_3)*cos(q_7)*sin(q_1)*sin(q_5)*sin(q_6) + cos(q_1)*cos(q_2)*cos(q_3)*cos(q_6)*cos(q_7)*sin(q_4) + cos(q_1)*cos(q_2)*cos(q_7)*sin(q_3)*sin(q_5)*sin(q_6) + cos(q_1)*cos(q_5)*cos(q_7)*sin(q_2)*sin(q_4)*sin(q_6) + cos(q_4)*cos(q_5)*cos(q_7)*sin(q_1)*sin(q_3)*sin(q_6) - 1.0*cos(q_1)*cos(q_2)*cos(q_3)*cos(q_4)*cos(q_5)*cos(q_7)*sin(q_6), cos(q_1)*cos(q_7)*sin(q_2)*sin(q_4)*sin(q_5) - 1.0*cos(q_1)*cos(q_2)*cos(q_5)*cos(q_7)*sin(q_3) - 1.0*cos(q_3)*cos(q_5)*cos(q_7)*sin(q_1) - 1.0*cos(q_1)*cos(q_4)*sin(q_2)*sin(q_6)*sin(q_7) + cos(q_4)*cos(q_7)*sin(q_1)*sin(q_3)*sin(q_5) + cos(q_3)*cos(q_6)*sin(q_1)*sin(q_5)*sin(q_7) + sin(q_1)*sin(q_3)*sin(q_4)*sin(q_6)*sin(q_7) - 1.0*cos(q_1)*cos(q_2)*cos(q_3)*cos(q_4)*cos(q_7)*sin(q_5) - 1.0*cos(q_1)*cos(q_2)*cos(q_3)*sin(q_4)*sin(q_6)*sin(q_7) + cos(q_1)*cos(q_2)*cos(q_6)*sin(q_3)*sin(q_5)*sin(q_7) + cos(q_1)*cos(q_5)*cos(q_6)*sin(q_2)*sin(q_4)*sin(q_7) + cos(q_4)*cos(q_5)*cos(q_6)*sin(q_1)*sin(q_3)*sin(q_7) - 1.0*cos(q_1)*cos(q_2)*cos(q_3)*cos(q_4)*cos(q_5)*cos(q_6)*sin(q_7)];

J21 = [ -1.0*cos(q_1)*sin(q_2), -1.0*cos(q_2)*sin(q_1), 0, 0, 0, 0, 0];
J22 = [ sin(q_1)*sin(q_3)*sin(q_4) - 1.0*cos(q_1)*cos(q_4)*sin(q_2) - 1.0*cos(q_1)*cos(q_2)*cos(q_3)*sin(q_4), cos(q_3)*sin(q_1)*sin(q_2)*sin(q_4) - 1.0*cos(q_2)*cos(q_4)*sin(q_1), cos(q_2)*sin(q_1)*sin(q_3)*sin(q_4) - 1.0*cos(q_1)*cos(q_3)*sin(q_4), sin(q_1)*sin(q_2)*sin(q_4) - 1.0*cos(q_1)*cos(q_4)*sin(q_3) - 1.0*cos(q_2)*cos(q_3)*cos(q_4)*sin(q_1), 0, 0, 0];
J23 = [ cos(q_1)*cos(q_4)*cos(q_7)*sin(q_2)*sin(q_6) - 1.0*cos(q_1)*cos(q_2)*cos(q_5)*sin(q_3)*sin(q_7) - 1.0*cos(q_3)*cos(q_5)*sin(q_1)*sin(q_7) - 1.0*cos(q_3)*cos(q_6)*cos(q_7)*sin(q_1)*sin(q_5) + cos(q_1)*sin(q_2)*sin(q_4)*sin(q_5)*sin(q_7) + cos(q_4)*sin(q_1)*sin(q_3)*sin(q_5)*sin(q_7) - 1.0*cos(q_7)*sin(q_1)*sin(q_3)*sin(q_4)*sin(q_6) - 1.0*cos(q_1)*cos(q_2)*cos(q_3)*cos(q_4)*sin(q_5)*sin(q_7) + cos(q_1)*cos(q_2)*cos(q_3)*cos(q_7)*sin(q_4)*sin(q_6) - 1.0*cos(q_1)*cos(q_2)*cos(q_6)*cos(q_7)*sin(q_3)*sin(q_5) - 1.0*cos(q_1)*cos(q_5)*cos(q_6)*cos(q_7)*sin(q_2)*sin(q_4) - 1.0*cos(q_4)*cos(q_5)*cos(q_6)*cos(q_7)*sin(q_1)*sin(q_3) + cos(q_1)*cos(q_2)*cos(q_3)*cos(q_4)*cos(q_5)*cos(q_6)*cos(q_7), cos(q_2)*cos(q_4)*cos(q_7)*sin(q_1)*sin(q_6) + cos(q_5)*sin(q_1)*sin(q_2)*sin(q_3)*sin(q_7) + cos(q_2)*sin(q_1)*sin(q_4)*sin(q_5)*sin(q_7) - 1.0*cos(q_2)*cos(q_5)*cos(q_6)*cos(q_7)*sin(q_1)*sin(q_4) + cos(q_3)*cos(q_4)*sin(q_1)*sin(q_2)*sin(q_5)*sin(q_7) - 1.0*cos(q_3)*cos(q_7)*sin(q_1)*sin(q_2)*sin(q_4)*sin(q_6) + cos(q_6)*cos(q_7)*sin(q_1)*sin(q_2)*sin(q_3)*sin(q_5) - 1.0*cos(q_3)*cos(q_4)*cos(q_5)*cos(q_6)*cos(q_7)*sin(q_1)*sin(q_2), cos(q_1)*cos(q_3)*cos(q_7)*sin(q_4)*sin(q_6) - 1.0*cos(q_2)*cos(q_3)*cos(q_5)*sin(q_1)*sin(q_7) - 1.0*cos(q_1)*cos(q_3)*cos(q_4)*sin(q_5)*sin(q_7) - 1.0*cos(q_1)*cos(q_5)*sin(q_3)*sin(q_7) - 1.0*cos(q_1)*cos(q_6)*cos(q_7)*sin(q_3)*sin(q_5) + cos(q_1)*cos(q_3)*cos(q_4)*cos(q_5)*cos(q_6)*cos(q_7) - 1.0*cos(q_2)*cos(q_3)*cos(q_6)*cos(q_7)*sin(q_1)*sin(q_5) + cos(q_2)*cos(q_4)*sin(q_1)*sin(q_3)*sin(q_5)*sin(q_7) - 1.0*cos(q_2)*cos(q_7)*sin(q_1)*sin(q_3)*sin(q_4)*sin(q_6) - 1.0*cos(q_2)*cos(q_4)*cos(q_5)*cos(q_6)*cos(q_7)*sin(q_1)*sin(q_3), cos(q_1)*cos(q_4)*cos(q_7)*sin(q_3)*sin(q_6) + cos(q_4)*sin(q_1)*sin(q_2)*sin(q_5)*sin(q_7) + cos(q_1)*sin(q_3)*sin(q_4)*sin(q_5)*sin(q_7) - 1.0*cos(q_7)*sin(q_1)*sin(q_2)*sin(q_4)*sin(q_6) + cos(q_2)*cos(q_3)*cos(q_4)*cos(q_7)*sin(q_1)*sin(q_6) - 1.0*cos(q_4)*cos(q_5)*cos(q_6)*cos(q_7)*sin(q_1)*sin(q_2) - 1.0*cos(q_1)*cos(q_5)*cos(q_6)*cos(q_7)*sin(q_3)*sin(q_4) + cos(q_2)*cos(q_3)*sin(q_1)*sin(q_4)*sin(q_5)*sin(q_7) - 1.0*cos(q_2)*cos(q_3)*cos(q_5)*cos(q_6)*cos(q_7)*sin(q_1)*sin(q_4), cos(q_1)*cos(q_3)*cos(q_5)*cos(q_6)*cos(q_7) - 1.0*cos(q_1)*cos(q_3)*sin(q_5)*sin(q_7) - 1.0*cos(q_1)*cos(q_4)*cos(q_5)*sin(q_3)*sin(q_7) + cos(q_2)*sin(q_1)*sin(q_3)*sin(q_5)*sin(q_7) + cos(q_5)*sin(q_1)*sin(q_2)*sin(q_4)*sin(q_7) - 1.0*cos(q_2)*cos(q_3)*cos(q_4)*cos(q_5)*sin(q_1)*sin(q_7) - 1.0*cos(q_2)*cos(q_5)*cos(q_6)*cos(q_7)*sin(q_1)*sin(q_3) - 1.0*cos(q_1)*cos(q_4)*cos(q_6)*cos(q_7)*sin(q_3)*sin(q_5) + cos(q_6)*cos(q_7)*sin(q_1)*sin(q_2)*sin(q_4)*sin(q_5) - 1.0*cos(q_2)*cos(q_3)*cos(q_4)*cos(q_6)*cos(q_7)*sin(q_1)*sin(q_5), cos(q_4)*cos(q_6)*cos(q_7)*sin(q_1)*sin(q_2) + cos(q_1)*cos(q_6)*cos(q_7)*sin(q_3)*sin(q_4) - 1.0*cos(q_1)*cos(q_3)*cos(q_7)*sin(q_5)*sin(q_6) + cos(q_2)*cos(q_3)*cos(q_6)*cos(q_7)*sin(q_1)*sin(q_4) - 1.0*cos(q_1)*cos(q_4)*cos(q_5)*cos(q_7)*sin(q_3)*sin(q_6) + cos(q_2)*cos(q_7)*sin(q_1)*sin(q_3)*sin(q_5)*sin(q_6) + cos(q_5)*cos(q_7)*sin(q_1)*sin(q_2)*sin(q_4)*sin(q_6) - 1.0*cos(q_2)*cos(q_3)*cos(q_4)*cos(q_5)*cos(q_7)*sin(q_1)*sin(q_6), cos(q_1)*cos(q_3)*cos(q_5)*cos(q_7) - 1.0*cos(q_2)*cos(q_5)*cos(q_7)*sin(q_1)*sin(q_3) - 1.0*cos(q_1)*cos(q_4)*cos(q_7)*sin(q_3)*sin(q_5) - 1.0*cos(q_1)*cos(q_3)*cos(q_6)*sin(q_5)*sin(q_7) + cos(q_7)*sin(q_1)*sin(q_2)*sin(q_4)*sin(q_5) - 1.0*cos(q_4)*sin(q_1)*sin(q_2)*sin(q_6)*sin(q_7) - 1.0*cos(q_1)*sin(q_3)*sin(q_4)*sin(q_6)*sin(q_7) - 1.0*cos(q_2)*cos(q_3)*cos(q_4)*cos(q_7)*sin(q_1)*sin(q_5) - 1.0*cos(q_1)*cos(q_4)*cos(q_5)*cos(q_6)*sin(q_3)*sin(q_7) - 1.0*cos(q_2)*cos(q_3)*sin(q_1)*sin(q_4)*sin(q_6)*sin(q_7) + cos(q_2)*cos(q_6)*sin(q_1)*sin(q_3)*sin(q_5)*sin(q_7) + cos(q_5)*cos(q_6)*sin(q_1)*sin(q_2)*sin(q_4)*sin(q_7) - 1.0*cos(q_2)*cos(q_3)*cos(q_4)*cos(q_5)*cos(q_6)*sin(q_1)*sin(q_7)];

J31 = [ 0, -1.0*sin(q_2), 0, 0, 0, 0, 0];
J32 = [ 0, - 1.0*cos(q_4)*sin(q_2) - 1.0*cos(q_2)*cos(q_3)*sin(q_4), sin(q_2)*sin(q_3)*sin(q_4), - 1.0*cos(q_2)*sin(q_4) - 1.0*cos(q_3)*cos(q_4)*sin(q_2), 0, 0, 0];
J33 = [ 0, cos(q_4)*cos(q_7)*sin(q_2)*sin(q_6) - 1.0*cos(q_2)*cos(q_5)*sin(q_3)*sin(q_7) + sin(q_2)*sin(q_4)*sin(q_5)*sin(q_7) - 1.0*cos(q_2)*cos(q_3)*cos(q_4)*sin(q_5)*sin(q_7) + cos(q_2)*cos(q_3)*cos(q_7)*sin(q_4)*sin(q_6) - 1.0*cos(q_2)*cos(q_6)*cos(q_7)*sin(q_3)*sin(q_5) - 1.0*cos(q_5)*cos(q_6)*cos(q_7)*sin(q_2)*sin(q_4) + cos(q_2)*cos(q_3)*cos(q_4)*cos(q_5)*cos(q_6)*cos(q_7), cos(q_4)*sin(q_2)*sin(q_3)*sin(q_5)*sin(q_7) - 1.0*cos(q_3)*cos(q_6)*cos(q_7)*sin(q_2)*sin(q_5) - 1.0*cos(q_3)*cos(q_5)*sin(q_2)*sin(q_7) - 1.0*cos(q_7)*sin(q_2)*sin(q_3)*sin(q_4)*sin(q_6) - 1.0*cos(q_4)*cos(q_5)*cos(q_6)*cos(q_7)*sin(q_2)*sin(q_3), cos(q_2)*cos(q_7)*sin(q_4)*sin(q_6) - 1.0*cos(q_2)*cos(q_4)*sin(q_5)*sin(q_7) + cos(q_2)*cos(q_4)*cos(q_5)*cos(q_6)*cos(q_7) + cos(q_3)*cos(q_4)*cos(q_7)*sin(q_2)*sin(q_6) + cos(q_3)*sin(q_2)*sin(q_4)*sin(q_5)*sin(q_7) - 1.0*cos(q_3)*cos(q_5)*cos(q_6)*cos(q_7)*sin(q_2)*sin(q_4), sin(q_2)*sin(q_3)*sin(q_5)*sin(q_7) - 1.0*cos(q_2)*cos(q_5)*sin(q_4)*sin(q_7) - 1.0*cos(q_3)*cos(q_4)*cos(q_5)*sin(q_2)*sin(q_7) - 1.0*cos(q_5)*cos(q_6)*cos(q_7)*sin(q_2)*sin(q_3) - 1.0*cos(q_2)*cos(q_6)*cos(q_7)*sin(q_4)*sin(q_5) - 1.0*cos(q_3)*cos(q_4)*cos(q_6)*cos(q_7)*sin(q_2)*sin(q_5), cos(q_3)*cos(q_6)*cos(q_7)*sin(q_2)*sin(q_4) - 1.0*cos(q_2)*cos(q_4)*cos(q_6)*cos(q_7) - 1.0*cos(q_2)*cos(q_5)*cos(q_7)*sin(q_4)*sin(q_6) + cos(q_7)*sin(q_2)*sin(q_3)*sin(q_5)*sin(q_6) - 1.0*cos(q_3)*cos(q_4)*cos(q_5)*cos(q_7)*sin(q_2)*sin(q_6), cos(q_2)*cos(q_4)*sin(q_6)*sin(q_7) - 1.0*cos(q_2)*cos(q_7)*sin(q_4)*sin(q_5) - 1.0*cos(q_5)*cos(q_7)*sin(q_2)*sin(q_3) - 1.0*cos(q_3)*cos(q_4)*cos(q_7)*sin(q_2)*sin(q_5) - 1.0*cos(q_2)*cos(q_5)*cos(q_6)*sin(q_4)*sin(q_7) - 1.0*cos(q_3)*sin(q_2)*sin(q_4)*sin(q_6)*sin(q_7) + cos(q_6)*sin(q_2)*sin(q_3)*sin(q_5)*sin(q_7) - 1.0*cos(q_3)*cos(q_4)*cos(q_5)*cos(q_6)*sin(q_2)*sin(q_7)];


Znew = [J11'*e_1+J21'*e_2+J31'*e_3, J12'*e_1+J22'*e_2+J32'*e_3, J13'*e_1+J23'*e_2+J33'*e_3];

end